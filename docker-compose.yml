version: '3.4'

x-default-service: &svc
  build:
    args: &args
      VENDOR: ${VENDOR:-chadgrant}
      GROUP: ${GROUP:-nogroupspecified}    
      SERVICE: ${SERVICE:-dynamodb-go-sample}
      SERVICE_FRIENDLY: ${SERVICE_FRIENDLY:-Sample API}
      SERVICE_DESCRIPTION: ${SERVICE_DESCRIPTION:-Sample API using dynamodb as a backing store}
      SERVICE_URL: ${SERICE_URL:-http://localhost:8080}
      BUILD_HASH: ${BUILD_HASH:-localbuild_hashmissing}
      BUILD_USER: ${BUILD_USER:-unknown}
      BUILD_BRANCH: ${BUILD_BRANCH:-nobranch}
      BUILD_NUMBER: ${BUILD_NUMBER:-1.0.0}
      BUILD_DATE: ${BUILD_DATE}
      BUILD_REPO: ${BUILD_REPO}

services:

  api:
    <<: *svc
    build:
      context: ./
      args:
        <<: *args
    image: ${DOCKER_REGISTRY:-docker.io}/${VENDOR:-chadgrant}/${DOCKER_IMAGE:-dynamodb-go-sample}:${BUILD_NUMBER:-1.0.0}
    container_name: sample_api
    restart: unless-stopped
    ports:
      - 5000:8080
    healthcheck:
      test: "curl -f http://localhost:8080/health/liveness || exit 1"
      interval: 30s
      timeout: 2s
      retries: 3
      start_period: 5s
    environment:
      DYNAMO_ENDPOINT: "http://data:8000"       
      AWS_REGION: "us-east-1"
      AWS_ACCESS_KEY_ID: key
      AWS_SECRET_ACCESS_KEY: secret
        
  tests:
    <<: *svc
    build:
      context: ./
      dockerfile: Dockerfile.tests
      args:
        <<: *args
    image: ${DOCKER_REGISTRY:-docker.io}/${VENDOR:-chadgrant}/${DOCKER_IMAGE:-dynamodb-go-sample}-test:${BUILD_NUMBER:-1.0.0}
    container_name: sample_api_test
    depends_on:
      - data
      - api
    environment:
      DYNAMO_ENDPOINT: "http://data:8000"
      TEST_INTEGRATION: 1

  ui:
    build:
      args:
        UI: typescript-react
      context: ./ui
    image: ${DOCKER_REGISTRY:-docker.io}/${VENDOR:-chadgrant}/${DOCKER_IMAGE:-dynamodb-go-sample}-ui:${BUILD_NUMBER:-1.0.0}
    container_name: sample_api_ui
    restart: unless-stopped
    ports:
      - 4000:80
    environment:
      API_ENDPOINT: "http://localhost:5000"

  data:
    build:
      context: ./db
    image: ${DOCKER_REGISTRY:-docker.io}/chadgrant/dynamodb-go-sample-db:${BUILD_NUMBER:-1.0.0}
    container_name: sample_api_data
    restart: unless-stopped
    ports:
      - 8000:8000